// Generated by CoffeeScript 1.10.0
(function() {
  var OnlineDeposit,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  OnlineDeposit = (function(superClass) {
    var model;

    extend(OnlineDeposit, superClass);

    function OnlineDeposit() {
      this.selectBonus = bind(this.selectBonus, this);
      this.clearError = bind(this.clearError, this);
      this.setError = bind(this.setError, this);
      this.setAmount = bind(this.setAmount, this);
      OnlineDeposit.__super__.constructor.apply(this, arguments);
      this.skipBonusModalId = "skipbonus-alert-modal";
      this.depositRequestInProgress = ko.observable(false);
      this.amount = ko.observable("0").extend({
        required: true,
        validatable: true,
        mustNotContainLetters: true,
        notNegativeAmount: true,
        isValidAmount: true,
        validation: [
          {
            validator: (function(_this) {
              return function(val, min) {
                var unformattedValue;
                unformattedValue = val.replace(/,/g, '');
                return unformattedValue >= min();
              };
            })(this),
            message: 'Amount must be greater or equals to a minimum deposit of ${0}',
            params: (function(_this) {
              return function() {
                return parseFloat($('#deposit-amount-min').val());
              };
            })(this)
          }, {
            validator: (function(_this) {
              return function(val, max) {
                var unformattedValue;
                if (max() === 0) {
                  return true;
                }
                unformattedValue = val.replace(/,/g, '');
                return unformattedValue <= max();
              };
            })(this),
            message: 'Amount must be less or equals to a maximum deposit of ${0}',
            params: (function(_this) {
              return function() {
                return parseFloat($('#deposit-amount-max').val());
              };
            })(this)
          }
        ]
      });
      this.amount.subscribe((function(_this) {
        return function() {
          return _this.claimedBonus(void 0);
        };
      })(this));
      $.ajax("/api/GetVisibleDepositQualifiedBonuses", {
        success: (function(_this) {
          return function(response) {
            return _this.bonuses(response);
          };
        })(this)
      });
      this.parseAmountString = (function(_this) {
        return function(amountStr) {
          var purgedString;
          purgedString = amountStr.replace(/,/g, '');
          return parseFloat(purgedString);
        };
      })(this);
      this.amountEntered = ko.computed((function(_this) {
        return function() {
          var value;
          value = _this.parseAmountString(_this.amount());
          return value > 0;
        };
      })(this));
      this.bonuses = ko.observableArray();
      this.claimedBonus = ko.observable();
      this.code = ko.observable('').extend({
        validatable: true
      });
      this.hasErrors = ko.observable(false);
      this.depositCaption = ko.computed((function(_this) {
        return function() {
          if (_this.claimedBonus()) {
            return i18n.t("balanceInformation.depositAndGetBonus");
          }
          return "Deposit";
        };
      })(this));
      this.submitRequest = (function(_this) {
        return function() {
          var bonusId;
          bonusId = _this.claimedBonus() === void 0 ? null : _this.claimedBonus().id;
          if (_this.bonuses().length > 0 && bonusId === null) {
            return $("#" + _this.skipBonusModalId).modal();
          } else {
            return _this.goAheadWithDeposititng();
          }
        };
      })(this);
      this.createOnlineDepositObject = (function(_this) {
        return function(bonusId) {
          var onlineDeposit;
          onlineDeposit = new OnlineDepositModel("/home/OnlineDepositConfirmation", '', function() {
            return popupAlert("Error occured.", "Contact an administrator.");
          });
          onlineDeposit.onlineAmount(_this.amount());
          return onlineDeposit.onlineDepositBonusId(bonusId);
        };
      })(this);
      this.submitCode = (function(_this) {
        return function() {
          var bonusByCode;
          _this.clearError(_this.code);
          bonusByCode = _.find(_this.bonuses(), function(item) {
            return item.code === _this.code();
          });
          if (bonusByCode !== void 0) {
            _this.claimedBonus(bonusByCode);
            return _this.code('');
          } else {
            return $.postJson("/api/ValidateFirstDepositBonus", {
              depositAmount: _this.amount(),
              bonusCode: _this.code()
            }).done(function(response) {
              var elem;
              if (response.isValid) {
                elem = _.find(_this.bonuses(), function(item) {
                  return item.id === response.bonus.id;
                });
                if (elem === void 0) {
                  _this.bonuses.unshift(response.bonus);
                  _this.claimedBonus(response.bonus);
                  return _this.code('');
                }
              } else {
                return _this.setError(_this.code, response.errors[0]);
              }
            }).fail(function(failResponse) {
              return popupAlert("Error occured.", "Contact an administrator.");
            });
          }
        };
      })(this);
      this.validate = (function(_this) {
        return function(url, data, onSuccess) {
          return $.postJson(url, data).done(function(response) {
            return onSuccess();
          }).fail(function(failResponse) {
            return _this.onErrorHandler(failResponse);
          });
        };
      })(this);
      this.onErrorHandler = (function(_this) {
        return function(failResponse) {
          var error, field, fieldname, i, len, ref, response, results;
          response = JSON.parse(failResponse.responseText);
          ref = response.errors;
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            error = ref[i];
            fieldname = error.fieldName;
            field = _this[fieldname.toLowerCase()];
            if (field) {
              field.error = error.message;
              results.push(field.__valid__(false));
            } else {
              results.push(void 0);
            }
          }
          return results;
        };
      })(this);
    }

    OnlineDeposit.prototype.setAmount = function(amount) {
      var addAmount;
      addAmount = this.parseAmountString(amount);
      return this.amount(addAmount.toString());
    };

    OnlineDeposit.prototype.setError = function(observable, errorMessage) {
      observable.error = errorMessage;
      return observable.__valid__(false);
    };

    OnlineDeposit.prototype.clearError = function(observable) {
      observable.error = '';
      return observable.__valid__(true);
    };

    OnlineDeposit.prototype.selectBonus = function(bonusItem) {
      if (this.amount() < bonusItem.requiredAmount) {
        return;
      }
      if (this.claimedBonus() !== bonusItem) {
        return this.claimedBonus(bonusItem);
      } else {
        return this.claimedBonus(void 0);
      }
    };

    OnlineDeposit.prototype.skipDepositAndGetBonus = function() {
      return $("#" + this.skipBonusModalId).modal('hide');
    };

    OnlineDeposit.prototype.goAheadWithDeposititng = function() {
      var data;
      data = {
        amount: this.amount()
      };
      return this.validate('/api/validateonlinedepositamount', data, (function(_this) {
        return function() {
          var bonusId, onlineDeposit;
          bonusId = _this.claimedBonus() === void 0 ? null : _this.claimedBonus().id;
          onlineDeposit = _this.createOnlineDepositObject(bonusId);
          return onlineDeposit.submitOnlineDeposit();
        };
      })(this));
    };

    model = new OnlineDeposit;

    model.errors = ko.validation.group(model);

    ko.applyBindings(model, document.getElementById("cashier-wrapper"));

    return OnlineDeposit;

  })(FormBase);

}).call(this);
