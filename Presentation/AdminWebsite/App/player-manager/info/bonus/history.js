// Generated by IcedCoffeeScript 108.0.9
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(["nav", 'durandal/app', "shell", "bonus/bonusCommon", "i18next", "config", "controls/grid"], function(nav, app, shell, common, i18N, config) {
    var ViewModel;
    return ViewModel = (function() {
      function ViewModel() {
        this.detached = __bind(this.detached, this);
        this.compositionComplete = __bind(this.compositionComplete, this);
        this.shell = shell;
        this.config = config;
        this.i18N = i18N;
        this.playerId = ko.observable();
        this.redemptionId = ko.observable(null);
        this.canBeCanceled = ko.observable(false);
        this.search = ko.observable();
      }

      ViewModel.prototype.activationFormatter = function() {
        return common.redemptionActivationFormatter(this.ActivationState);
      };

      ViewModel.prototype.typeFormatter = function() {
        return common.typeFormatter(this.TemplateType);
      };

      ViewModel.prototype.reloadGrid = function() {
        return $('#redemption-grid').trigger("reload");
      };

      ViewModel.prototype.compositionComplete = function() {
        $("#redemption-grid").on("gridLoad selectionChange", (function(_this) {
          return function(e, row) {
            _this.redemptionId(row.id);
            return _this.canBeCanceled(row.data.CanBeCanceled === "true");
          };
        })(this));
        return $(document).on("redemptions_changed", this.reloadGrid);
      };

      ViewModel.prototype.detached = function() {
        return $(document).off("redemptions_changed", this.reloadGrid);
      };

      ViewModel.prototype.openViewTab = function() {
        if (this.redemptionId()) {
          return nav.open({
            path: "player-manager/info/bonus/view-redemption",
            title: i18N.t("playerManager.bonusHistory.view"),
            data: {
              playerId: this.playerId(),
              redemptionId: this.redemptionId()
            }
          });
        }
      };

      ViewModel.prototype.activate = function(data) {
        return this.playerId(data.playerId);
      };

      ViewModel.prototype.cancel = function() {
        if (this.redemptionId()) {
          return app.showMessage(i18N.t('playerManager.bonusHistory.messages.cancelRedemption'), i18N.t('playerManager.bonusHistory.messages.confirmCancellation'), [
            {
              text: i18N.t('common.booleanToYesNo.true'),
              value: true
            }, {
              text: i18N.t('common.booleanToYesNo.false'),
              value: false
            }
          ], false, {
            style: {
              width: "450px"
            }
          }).then((function(_this) {
            return function(confirmed) {
              if (confirmed) {
                return $.post(config.adminApi("/BonusHistory/Cancel"), {
                  playerId: _this.playerId(),
                  redemptionId: _this.redemptionId()
                }).done(function(data) {
                  if (data.Success) {
                    $(document).trigger("redemptions_changed");
                    _this.canBeCanceled(false);
                    return app.showMessage(i18N.t("playerManager.bonusHistory.messages.canceledSuccessfully"), i18N.t("playerManager.bonusHistory.cancel"), [i18N.t("common.close")]);
                  } else {
                    return app.showMessage(data.Errors[0].ErrorMessage, i18N.t("common.error"), [i18N.t("common.close")]);
                  }
                });
              }
            };
          })(this));
        }
      };

      return ViewModel;

    })();
  });

}).call(this);
