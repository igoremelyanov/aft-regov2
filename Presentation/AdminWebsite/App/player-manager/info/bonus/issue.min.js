(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["bonus/bonusCommon","i18next","shell","./description-dialog","config","controls/grid"],function(t,i,r,u,f){return function(){function e(){this.issueBonus=n(this.issueBonus,this);this.backToList=n(this.backToList,this);this.proceed=n(this.proceed,this);this.attached=n(this.attached,this);this.shell=r;this.config=f;this.i18N=i;this.playerId=ko.observable();this.stages={bonusTable:0,loadingSpinner:1,issuanceUI:2};this.currentStage=ko.observable(this.stages.bonusTable);this.bonusToIssue=ko.observable();this.transactions=ko.observableArray();this.currentTransaction=ko.observable();this.errors=ko.observableArray();this.bonusIssued=ko.observable(!1)}return e.prototype.typeFormatter=function(){return t.typeFormatter(this.Type)},e.prototype.statusFormatter=function(){return i.t(i.t("playerManager.bonus.statuses."+this.Status))},e.prototype.activate=function(n){return this.playerId(n.playerId)},e.prototype.attached=function(n){var t;t=findGrid(n);$("form",n).submit(function(){return t.trigger("reload"),!1});t.on("gridLoad selectionChange",function(n){return function(t,i){if(i.id!=null)return n.bonusToIssue({id:i.id,name:i.data.Name,description:$(i.data.Description).attr("title")})}}(this));return $(n).on("click",".player-bonus-description",function(){var n;return n=$(this).attr("title"),new u(n).show()})},e.prototype.proceed=function(){return this.stages.loadingSpinner,$.get(f.adminApi("/IssueBonus/Transactions"),{playerId:this.playerId(),bonusId:this.bonusToIssue().id}).done(function(n){return function(t){var i;return n.transactions(function(){var n,f,r,u;for(r=t.Transactions,u=[],n=0,f=r.length;n<f;n++)i=r[n],u.push({id:i.Id,description:""+i.Date+" | "+i.CurrencyCode+i.Amount,bonusAmount:""+i.CurrencyCode+i.BonusAmount});return u}()),n.currentStage(n.stages.issuanceUI)}}(this))},e.prototype.backToList=function(){return this.currentTransaction(null),this.currentStage(this.stages.bonusTable),this.bonusIssued(!1)},e.prototype.issueBonus=function(){return this.currentStage(this.stages.loadingSpinner),$.ajax({type:"POST",url:f.adminApi("/IssueBonus/IssueBonus"),data:{playerId:this.playerId(),bonusId:this.bonusToIssue().id,transactionId:this.currentTransaction().id},dataType:"json"}).done(function(n){return function(t){return n.currentStage(n.stages.issuanceUI),t.Success?(n.currentTransaction(null),n.bonusIssued(!0)):n.errors(t.Errors)}}(this))},e}()})}).call(this);