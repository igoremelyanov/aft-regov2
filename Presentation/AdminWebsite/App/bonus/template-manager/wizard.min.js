(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["komapping","nav","bonus/bonusCommon","i18next","config","./info","./availability","./rules","./wagering","./notification","./summary","./rewardTier","dateBinders","wizard"],function(t,i,r,u,f,e,o,s,h,c,l,a){return function(){function v(){this.getCurrentWizardCount=n(this.getCurrentWizardCount,this);this.disable=n(this.disable,this);this.enable=n(this.enable,this);this.toggleButtonsVisibility=n(this.toggleButtonsVisibility,this);this.showNext=n(this.showNext,this);this.show=n(this.show,this);this.compositionComplete=n(this.compositionComplete,this);this.bindingComplete=n(this.bindingComplete,this);this.activate=n(this.activate,this);this.submit=n(this.submit,this);var t,i;this.Id=ko.observable();this.Version=ko.observable();this.serverErrors=ko.observable();this.steps=[{index:0,name:"Info"},{index:1,name:"Availability"},{index:2,name:"Rules"},{index:3,name:"Wagering"},{index:4,name:"Notification"},{index:5,name:"Summary"}];this.initialStep=this.steps[0];this.allowedSteps=ko.observableArray([this.steps[0]]);this.wizardSelector=".template-wizard";i=this.getCurrentWizardCount();this.tabs=function(){var n,r,f;for(f=[],t=n=0,r=this.steps.length-1;0<=r?n<=r:n>=r;t=0<=r?++n:--n)f.push({tabId:"tab"+(i*10+t),stepNumber:t+1,stepName:u.t("bonus.wizardSteps."+t)});return f}.call(this);this.prevBtnClass="wizard-prev"+i;this.nextBtnClass="wizard-next"+i;this.closeBtnText=ko.observable();this.isNextBtnVisible=ko.observable(!0);this.isPrevBtnVisible=ko.observable(!0)}return v.prototype.close=function(){return i.close()},v.prototype.submit=function(n,i,u){var e,o,s,h;return(this.Rules.isFundIn()===!1&&this.Rules.FundInWallets([]),this.Rules.isReferFriends()===!1&&(this.Rules.ReferFriendMinDepositAmount(0),this.Rules.ReferFriendWageringCondition(0)),h=ko.utils.arrayFirst(this.steps,function(n){return n.index===u-1}),s=h.name,e=this[s],e.isValid()===!1)?(e.errors.showAllMessages(),!1):(this.Availability.VipLevels(this.Availability.vVipLevels().length===this.Availability.availableVips().length?[]:this.Availability.vVipLevels()),this.serverErrors(null),e.tracker.isDirty()?(o={Id:this.Id(),Version:this.Version()},o[s]=JSON.parse(t.toJSON(e,{ignore:r.getIgnoredFieldNames(e)})),$.ajax({type:"POST",url:f.adminApi("BonusTemplate/CreateEdit"),data:ko.toJSON(o),dataType:"json",contentType:"application/json",traditional:!0}).done(function(n){return function(t){if(t.Success){if(n.Id(t.Id),n.Version(t.Version),$(document).trigger("bonus_templates_changed"),e.tracker.markCurrentStateAsClean(),n.showNext(ko.utils.arrayFirst(n.steps,function(n){return n.index===u})),u===2&&n.Info.allowChangeBrand(!1),u===1)return n.Info.allowChangeType(!1)}else return t.Errors.forEach(function(t){var i;return i=t.PropertyName.split("."),i[0]==="Template"||i[1]==="GameContributions"||i[1]==="RewardTiers"?n.serverErrors([t.ErrorMessage]):setError(n[i[0]][i[1]],t.ErrorMessage)}),e.errors.showAllMessages()}}(this)),!1):!0)},v.prototype.activate=function(n){return $.get(f.adminApi("BonusTemplate/GetRelatedData"),{id:n!=null?n.id:void 0}).done(function(i){return function(r){var u,g,b,f,nt,v,y,p,w,tt,it,k,d;if(i.Info=new e(r.Licensees),i.Availability=new o(i.Info.currentBrand,r.Bonuses),i.Rules=new s(i.Info.TemplateType,i.Info.currentBrand),i.Wagering=new h(i.Rules.isFirstOrReloadDeposit,i.Rules.isFundIn,r.Games,i.Info.currentBrand),i.Notification=new c(r.NotificationTriggers),i.Summary=new l(i.Info,i.Availability,i.Rules,i.Wagering,i.Notification),n!=null)if(i.Info.allowChangeType(!1),i.Info.allowChangeBrand(!1),y=r.Template,b={ignore:function(){var n=[];for(f in y)y[f]===null&&n.push(f);return n}()},b.RewardTiers={create:function(n){return new a(n.data)}},t.fromJS(y,b,i),i.Info.BrandId.valueHasMutated(),i.Rules.currencies(function(){var n,r,t,i;for(t=this.Rules.RewardTiers(),i=[],n=0,r=t.length;n<r;n++)nt=t[n],i.push(nt.CurrencyCode);return i}.call(i)),n.view!==void 0)i.initialStep=i.steps[5],i.allowedSteps(i.steps[5]);else{for(u=[],k=function(){var n=[];for(f in y)y[f]!==null&&n.push(f);return n}(),p=0,tt=k.length;p<tt;p++)for(f=k[p],d=i.steps,w=0,it=d.length;w<it;w++)v=d[w],v.name===f&&u.push(v);u.length<i.steps.length-1&&(g=u[u.length-1].index+1,v=ko.utils.arrayFirst(i.steps,function(n){return n.index<5&&n.index===g}),v.skipMarkAsClean=!0,u.push(v));n.complete&&u.push(i.steps[5]);i.allowedSteps(u)}return i.Rules.selectRewardType(i.Rules.RewardType()),i.Wagering.selectWageringMethod(i.Wagering.Method())}}(this))},v.prototype.bindingComplete=function(){var n,t,i,f,e,r,u;for(this.element=$(this.wizardSelector).last().bootstrapWizard({tabClass:"nav nav-pills nav-justified",previousSelector:"."+this.prevBtnClass,nextSelector:"."+this.nextBtnClass,onNext:this.submit,onTabClick:function(n){return function(t,i,r,u){var f;return f=ko.utils.arrayFilter(n.allowedSteps(),function(n){return n.index===u}),f.length>0}}(this),onTabShow:this.toggleButtonsVisibility}),r=this.steps,t=0,f=r.length;t<f;t++)n=r[t],this.disable(n);for(u=this.allowedSteps(),i=0,e=u.length;i<e;i++)n=u[i],this.enable(n);return this.show(this.initialStep)},v.prototype.compositionComplete=function(){var i,n,u,r,f,t;for(r=this.allowedSteps(),t=[],n=0,u=r.length;n<u;n++)i=r[n],i.skipMarkAsClean===void 0?t.push((f=this[i.name].tracker)!=null?f.markCurrentStateAsClean():void 0):t.push(void 0);return t},v.prototype.show=function(n){return this.element.bootstrapWizard("show",n.index)},v.prototype.showNext=function(n){return this.allowedSteps.push(n),this.enable(n),this.show(n)},v.prototype.toggleButtonsVisibility=function(n,t,i){var r;return this.closeBtnText(u.t("common.close")),this.isNextBtnVisible(!0),this.isPrevBtnVisible(!0),r=this.steps[i],r===this.steps[0]&&this.isPrevBtnVisible(!1),r===this.steps[5]&&(this.closeBtnText(u.t("bonus.templateManager.finish")),this.isNextBtnVisible(!1)),this.initialStep===this.steps[5]?(this.closeBtnText(u.t("common.close")),this.isPrevBtnVisible(!1),this.isNextBtnVisible(!1)):void 0},v.prototype.enable=function(n){return this.element.bootstrapWizard("enable",n.index)},v.prototype.disable=function(n){return this.element.bootstrapWizard("disable",n.index)},v.prototype.getCurrentWizardCount=function(){var r,t,u,f,e,i,n;return i=0,n=$(""+this.wizardSelector+" a[data-toggle='tab']"),n.length>0&&(t=function(){var t,r,i;for(i=[],t=0,r=n.length;t<r;t++)f=n[t],i.push($(f).attr("href"));return i}(),e=function(){var n,u,i;for(i=[],n=0,u=t.length;n<u;n++)r=t[n],i.push(parseInt(r.slice(4)));return i}(),u=Math.max.apply(Math,e),i=Math.floor(u/10)+1),i},v}()})}).call(this);