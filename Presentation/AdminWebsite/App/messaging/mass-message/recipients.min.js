(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["i18next","config","datePicker"],function(t,i){return function(){function r(r){this.updateRecipients=n(this.updateRecipients,this);this.getDateAsUtc=n(this.getDateAsUtc,this);this.reload=n(this.reload,this);this.validateRegistrationDateChange=n(this.validateRegistrationDateChange,this);this.config=i;this.Id=ko.observable();this.searchGridSelector="#mass-message-search-grid";this.recipientsGridSelector="#mass-message-recipients-grid";this.allowChangeBrand=ko.observable(!0);this.availableLicensees=ko.observableArray(r);this.selectedLicensee=ko.observable();this.availableBrands=ko.computed(function(n){return function(){return n.selectedLicensee()?n.selectedLicensee().brands:[]}}(this));this.selectedBrand=ko.observable();this.availablePaymentLevels=ko.computed(function(n){return function(){return n.selectedBrand()?n.selectedBrand().paymentLevels:[]}}(this));this.availableVipLevels=ko.computed(function(n){return function(){return n.selectedBrand()?n.selectedBrand().vipLevels:[]}}(this));this.availableStatuses=ko.observableArray([{name:t.t("common.active"),value:"Active"},{name:t.t("common.inactive"),value:"Inactive"}]);this.registrationDateFrom=ko.observable();this.registrationDateFrom.subscribe(function(n){return function(){var t;return t=n.validateRegistrationDateChange(!0),t?n.reload(n.searchGridSelector):void 0}}(this));this.registrationDateTo=ko.observable();this.registrationDateTo.subscribe(function(n){return function(){var t;return t=n.validateRegistrationDateChange(!1),t?n.reload(n.searchGridSelector):void 0}}(this));this.BrandId=ko.computed(function(n){return function(){return n.selectedBrand()?n.selectedBrand().id:null}}(this));this.BrandId.subscribe(function(n){return function(){return n.reload(n.searchGridSelector)}}(this));this.SearchTerm=ko.observable("");this.SearchTerm.extend({rateLimit:{timeout:1e3,method:"notifyWhenChangesStop"}});this.SearchTerm.subscribe(function(n){return function(){return n.reload(n.searchGridSelector)}}(this));this.PaymentLevelId=ko.observable();this.PaymentLevelId.subscribe(function(n){return function(){return n.reload(n.searchGridSelector)}}(this));this.VipLevelId=ko.observable();this.VipLevelId.subscribe(function(n){return function(){return n.reload(n.searchGridSelector)}}(this));this.Status=ko.observable();this.Status.subscribe(function(n){return function(){return n.reload(n.searchGridSelector)}}(this));this.RegistrationDateFrom=ko.observable("");this.RegistrationDateTo=ko.observable("");this.allowChangeBrand=ko.observable(!0);this.all=ko.observable(t.t("common.all"));this.HasRecipients=ko.observable(!1).extend({validation:{validator:function(){return function(n){return n===!0}}(this),message:t.t("messaging.massMessage.recipientRequired")}});this.Languages=ko.observableArray();this.compositionComplete=function(n){return function(){return $(function(){var t,i;i=!1;t=!1;$(n.searchGridSelector).on("selectionChange",function(t,r){var u,f;if(!i)return f=r.isSelected?"SelectSingle":"UnselectSingle",u=r.id,n.updateRecipients(f,u,[n.recipientsGridSelector])});$(n.searchGridSelector).on("selectAllChange",function(t,i){var r;return r=i.allSelected?"SearchResultSelectAll":"SearchResultUnselectAll",n.updateRecipients(r,null,[n.recipientsGridSelector])});$(n.recipientsGridSelector).on("selectionChange",function(i,r){if(!t)return n.updateRecipients("UnselectSingle",r.id,[n.searchGridSelector,n.recipientsGridSelector])});$(n.recipientsGridSelector).on("selectAllChange",function(){if(!t)return n.updateRecipients("RecipientsListUnselectAll",null,[n.searchGridSelector,n.recipientsGridSelector])});$(n.searchGridSelector).on("gridLoad",function(t,r){var o,f,s,h,u,c,e;for(i=!0,o=$(n.searchGridSelector),s=o.find(".ui-jqgrid-btable"),h=r.tableData,e=h.rows,u=0,c=e.length;u<c;u++)f=e[u],f.cell.Selected&&s.jqGrid("setSelection",f.id,!0);return i=!1});return $(n.recipientsGridSelector).on("gridLoad",function(){var i,r;return t=!0,r=$(n.recipientsGridSelector),i=r.find('th input[type="checkbox"]'),i.click(),t=!1})}),ko.validation.group(n)}}(this)}return r.prototype.validateRegistrationDateChange=function(n){var t,r,u,i,f;return u=!0,r=$("input[data-bind*='datepicker: registrationDateFrom']"),t=r.datepicker("getDate"),f=$("input[data-bind*='datepicker: registrationDateTo']"),i=f.datepicker("getDate"),n&&t&&this.RegistrationDateFrom(this.getDateAsUtc(t)),!n&&i&&this.RegistrationDateTo(this.getDateAsUtc(i)),i&&t&&t>i&&(u=!1,n?f.datepicker("setDate",t):r.datepicker("setDate",i)),u},r.prototype.reload=function(n){return $(n).trigger("reload")},r.prototype.getDateAsUtc=function(n){return n.getFullYear()+"-"+this.pad(n.getMonth()+1)+"-"+this.pad(n.getDate())+"T00:00:00-00:00Z"},r.prototype.pad=function(n){return n<10?"0"+n:n},r.prototype.updateRecipients=function(n,t,r){var u;return this.allowChangeBrand(!1),u={Id:this.Id(),UpdateRecipientsType:n,PlayerId:t,SearchPlayersRequest:{BrandId:this.BrandId(),SearchTerm:this.SearchTerm(),PaymentLevelId:this.PaymentLevelId(),VipLevelId:this.VipLevelId(),PlayerStatus:this.Status(),RegistrationDateFrom:this.RegistrationDateFrom(),RegistrationDateTo:this.RegistrationDateTo()}},$.ajax({type:"POST",url:i.adminApi("MassMessage/UpdateRecipients"),data:ko.toJSON(u),dataType:"json",contentType:"application/json"}).done(function(n){return function(t){return n.Id(t.id),n.HasRecipients(t.hasRecipients),ko.mapping.fromJS(t.languages,{},n.Languages),$.each(r,function(t,i){return n.reload(i)})}}(this))},r}()})}).call(this);