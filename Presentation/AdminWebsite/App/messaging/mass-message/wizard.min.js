(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["komapping","nav","i18next","config","./recipients","./content","./send-dialog","wizard"],function(t,i,r,u,f,e,o){return function(){function t(){this.getCurrentWizardCount=n(this.getCurrentWizardCount,this);this.disable=n(this.disable,this);this.enable=n(this.enable,this);this.toggleButtonsVisibility=n(this.toggleButtonsVisibility,this);this.showNext=n(this.showNext,this);this.show=n(this.show,this);this.backToRecipients=n(this.backToRecipients,this);this.bindingComplete=n(this.bindingComplete,this);this.activate=n(this.activate,this);this.send=n(this.send,this);this.submit=n(this.submit,this);var t,i;this.Id=ko.observable();this.serverErrors=ko.observable();this.steps=[{index:0,name:"Recipients"},{index:1,name:"Content"}];this.initialStep=this.steps[0];this.allowedSteps=ko.observableArray([this.steps[0]]);this.wizardSelector=".template-wizard";i=this.getCurrentWizardCount();this.tabs=function(){var n,u,f;for(f=[],t=n=0,u=this.steps.length-1;0<=u?n<=u:n>=u;t=0<=u?++n:--n)f.push({tabId:"tab"+(i*10+t),stepNumber:t+1,stepName:r.t("messaging.massMessage.wizardSteps."+t)});return f}.call(this);this.prevBtnClass="wizard-prev"+i;this.nextBtnClass="wizard-next"+i;this.closeBtnText=ko.observable();this.isNextBtnVisible=ko.observable(!0);this.isPrevBtnVisible=ko.observable(!0)}return t.prototype.close=function(){return i.close()},t.prototype.submit=function(n,t,i){return this.Recipients.isValid()?(this.serverErrors(null),this.showNext(ko.utils.arrayFirst(this.steps,function(n){return n.index===i})),this.Content.Id(this.Recipients.Id()),this.Content.setLanguages(this.Recipients.Languages()),!0):(this.Recipients.errors.showAllMessages(),!1)},t.prototype.send=function(){var n,t,i;return t=!0,$.each(this.Content.Languages(),function(){return function(n,i){var r;return r=i.isValid(),r?void 0:(t=!1,i.errors.showAllMessages())}}(this)),t?(n=[],$.each(this.Content.Languages(),function(){return function(t,i){return n.push({languageCode:i.languageCode(),onSite:i.onSite(),onSiteSubject:i.onSiteSubject(),onSiteContent:i.onSiteContent()})}}(this)),i={id:this.Content.Id(),content:n},$.ajax({type:"POST",url:u.adminApi("MassMessage/Send"),data:ko.toJSON(i),dataType:"json",contentType:"application/json",traditional:!0}).done(function(n){return function(t){var i;if(t.isSent)return i=new o(n.close),i.show()}}(this))):void 0},t.prototype.activate=function(){return $.get(u.adminApi("MassMessage/GetNewData")).done(function(n){return function(t){return n.Recipients=new f(t.licensees),n.Content=new e}}(this))},t.prototype.bindingComplete=function(){var n,t,i,f,e,r,u;for(this.element=$(this.wizardSelector).last().bootstrapWizard({tabClass:"nav nav-pills nav-justified",previousSelector:"."+this.prevBtnClass,nextSelector:"."+this.nextBtnClass,onNext:this.submit,onTabClick:function(n){return function(t,i,r,u){var f,e;return f=ko.utils.arrayFilter(n.allowedSteps(),function(n){return n.index===u}),e=f.length>0,r===1&&u===0&&n.backToRecipients(),e}}(this),onPrevious:this.backToRecipients,onTabShow:this.toggleButtonsVisibility}),r=this.steps,t=0,f=r.length;t<f;t++)n=r[t],this.disable(n);for(u=this.allowedSteps(),i=0,e=u.length;i<e;i++)n=u[i],this.enable(n);return this.show(this.initialStep)},t.prototype.backToRecipients=function(){return this.disable(this.steps[1]),this.allowedSteps.removeAll(),this.allowedSteps.push(this.steps[0])},t.prototype.show=function(n){return this.element.bootstrapWizard("show",n.index)},t.prototype.showNext=function(n){return this.allowedSteps.push(n),this.enable(n),this.show(n)},t.prototype.toggleButtonsVisibility=function(n,t,i){var u;return this.closeBtnText(r.t("common.close")),this.isNextBtnVisible(!0),this.isPrevBtnVisible(!0),u=this.steps[i],u===this.steps[0]&&this.isPrevBtnVisible(!1),u===this.steps[1]?this.isNextBtnVisible(!1):void 0},t.prototype.enable=function(n){return this.element.bootstrapWizard("enable",n.index)},t.prototype.disable=function(n){return this.element.bootstrapWizard("disable",n.index)},t.prototype.getCurrentWizardCount=function(){var r,t,u,f,e,i,n;return i=0,n=$(""+this.wizardSelector+" a[data-toggle='tab']"),n.length>0&&(t=function(){var t,r,i;for(i=[],t=0,r=n.length;t<r;t++)f=n[t],i.push($(f).attr("href"));return i}(),e=function(){var n,u,i;for(i=[],n=0,u=t.length;n<u;n++)r=t[n],i.push(parseInt(r.slice(4)));return i}(),u=Math.max.apply(Math,e),i=Math.floor(u/10)+1),i},t}()})}).call(this);