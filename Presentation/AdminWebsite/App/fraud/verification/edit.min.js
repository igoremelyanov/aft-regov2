(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["nav","durandal/app","i18next","security/security","shell","controls/grid","JqGridUtil","CommonNaming","EntityFormUtil","fraud/verification/WinningRule","dateTimePicker","dateBinders"],function(t,i,r,u,f,e,o,s,h,c){return function(){function i(){this.loadVipLevels=n(this.loadVipLevels,this);var i,u,f,t,e;t=this;this.self2=this;this.disabled=ko.observable(!1);this.editMode=ko.observable(!1);this.configuration={};this.form=new h.Form(this);this.dummyObservable=ko.observable();this.message=ko.observable;this.messageClass=ko.observable;this.operators=ko.observableArray([{text:">",value:0},{text:"<",value:1},{text:">=",value:2},{text:"<=",value:3}]);h.setupLicenseeField2(this);h.setupBrandField2(this);this.form.makeField("hasWinLoss",ko.observable(!1));this.form.makeField("hasCompleteDocuments",ko.observable(!1));this.form.makeField("winLossOperator",ko.observable());this.winLossOperatorTitle=ko.computed(function(){return t.getOperator(t.fields.winLossOperator())});this.form.makeField("winLossAmount",ko.observable(0).extend({formatDecimal:2,validatable:!0,validation:[{validator:function(){return function(n){return t.dummyObservable(),!t.fields.hasWinLoss()||n>=0}}(this),message:r.t("app:common.validationMessages.amountGreaterOrEquals",{amount:0})}],min:{params:0,message:r.t("app:common.validationMessages.amountGreaterOrEquals",{amount:0})},max:{params:2147483647,message:r.t("app:common.validationMessages.amountIsBiggerThenAllowed")},required:!0}));this.form.makeField("hasTotalDepositAmount",ko.observable(!1));this.form.makeField("totalDepositAmountOperator",ko.observable());this.totalDepositAmountOperatorTitle=ko.computed(function(){return t.getOperator(t.fields.totalDepositAmountOperator())});this.form.makeField("totalDepositAmount",ko.observable(.01).extend({formatDecimal:2,validatable:!0,validation:[{validator:function(){return function(n){return t.dummyObservable(),!t.fields.hasTotalDepositAmount()||n>=0}}(this),message:r.t("app:common.validationMessages.amountGreaterOrEquals",{amount:.01})}],required:!0,min:{params:.01,message:r.t("app:common.validationMessages.amountGreaterOrEquals",{amount:.01})},max:{params:2147483647,message:r.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasWithdrawalCount",ko.observable(!1));this.form.makeField("totalWithdrawalCountOperator",ko.observable());this.totalWithdrawalCountOperatorTitle=ko.computed(function(){return t.getOperator(t.fields.totalWithdrawalCountOperator())});this.form.makeField("totalWithdrawalCountAmount",ko.observable(1).extend({formatInt:{allowNegative:!1,allowEmpty:!0},validatable:!0,validation:[{validator:function(){return function(n){return t.dummyObservable(),!t.fields.hasWithdrawalCount()||n>=1}}(this),message:r.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}],max:{params:2147483647,message:r.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasWithdrawalExemption",ko.observable(!1));this.form.makeField("hasDepositCount",ko.observable(!1));this.form.makeField("totalDepositCountOperator",ko.observable());this.totalDepositCountOperatorTitle=ko.computed(function(){return t.getOperator(t.fields.totalDepositCountOperator())});this.form.makeField("totalDepositCountAmount",ko.observable(1).extend({formatInt:{allowNegative:!1,allowEmpty:!0},required:!0,validatable:!0,validation:[{required:!0,validator:function(){return function(n){return t.dummyObservable(),!t.fields.hasDepositCount()||n>=1}}(this),message:r.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}],max:{params:2147483647,message:r.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasAccountAge",ko.observable(!1));this.form.makeField("accountAge",ko.observable(1).extend({formatInt:{allowNegative:!1,allowEmpty:!0},validatable:!0,required:!0,validation:[{validator:function(){return function(n){return t.dummyObservable(),!t.fields.hasAccountAge()||n>=1}}(this),message:r.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}]}));this.form.makeField("accountAgeOperator",ko.observable());this.accountAgeOperatorTitle=ko.computed(function(){return t.getOperator(t.fields.accountAgeOperator())});this.form.makeField("id",ko.observable()).lockValue(!0);this.form.makeField("hasFraudRiskLevel",ko.observable(!1));this.form.makeField("hasWithdrawalExemption",ko.observable(!1));this.form.makeField("hasNoRecentBonus",ko.observable(!1));this.form.makeField("hasWinnings",ko.observable(!1));this.winningRules=ko.observableArray();i=this.form.makeField("currency",ko.observable().extend({required:!0})).hasOptions();i.setSerializer(function(){return i.value()}).setDisplay(ko.computed(function(){return i.value()}));e=this.form.makeField("vipLevels",ko.observableArray([]).extend({validation:[{validator:function(){return function(n){return n.length>0}}(this),message:"Should be at least one"}]})).hasOptions();e.setSerializer(function(){return _.map(e.value(),function(){return function(n){return n.id}}(this))});this.form.makeField("hasPaymentLevel",ko.observable(!1));this.paymentLevelsAssignControl=new h.AssignControl;u=this.form.makeField("paymentLevels",this.paymentLevelsAssignControl.assignedItems);u.setSerializer(function(){var n,t,i;for(t=[],i=u.value(),n=0;n<i.length;)t[n]=i[n].id,n++;return t});this.fraudRiskLevelsAssignControl=new h.AssignControl;f=this.form.makeField("riskLevels",this.fraudRiskLevelsAssignControl.assignedItems);f.setSerializer(function(){var n,t,i;for(t=[],i=f.value(),n=0;n<i.length;)t[n]=i[n].id,n++;return t});h.publishIds(this,"verification-",["licensee","brand","currency","vipLevels","hasFraudRiskLevel","hasCompleteDocuments","riskLevels","hasPaymentLevel","paymentLevels","hasWinnings","hasNoRecentBonus","hasWithdrawalExemption","hasWinLoss","winLossOperator","winLossAmount","hasTotalDepositAmount","totalDepositAmountOperator","totalDepositAmount","hasDepositCount","totalDepositCountOperator","totalDepositCountAmount","hasWithdrawalCount","totalWithdrawalCountOperator","totalWithdrawalCountAmount","hasAccountAge","accountAge","accountAgeOperator"]);h.addCommonMembers(this);this.form.publishIsReadOnly(["licensee","brand","currency","vipLevels","hasFraudRiskLevel","hasCompleteDocuments","riskLevels","hasPaymentLevel","paymentLevels","hasWinnings","hasNoRecentBonus","hasWithdrawalExemption","hasWinLoss","winLossOperator","winLossAmount","hasTotalDepositAmount","totalDepositAmountOperator","totalDepositAmount","hasDepositCount","totalDepositCountOperator","totalDepositCountAmount","hasWithdrawalCount","totalWithdrawalCountOperator","totalWithdrawalCountAmount","hasAccountAge","accountAge","accountAgeOperator"])}var u,e,o,s;return i.prototype.getBrandId=function(){var n;return n=this.form.fields.brand.value(),n?n.id:null},i.prototype.activate=function(n){var i,t;return t=this,t.fields.id(n?n.id:null),t.editMode(n?n.editMode:!1),t.submitted(t.editMode()===!1),i=$.Deferred(),t.fields.id()?(t.loadConfiguration(i),t.submitted(this.editMode()===!1)):this.load(i),i.promise()},i.prototype.loadConfiguration=function(n){var t;return t=this,$.ajax("autoVerification/GetById?id="+this.fields.id(),{success:function(i){return t.load(n,i)}})},i.prototype.compositionComplete=function(){return this},i.prototype.formatDate=function(n){var i,r,t,u;return t=this,u=n.getFullYear(),r=n.getMonth()+1,i=n.getDate(),u+"/"+t.formatDateNumber(r)+"/"+t.formatDateNumber(i)},i.prototype.formatDateNumber=function(n){return n<10?"0"+n:n},i.prototype.load=function(n,t){var r,u,i;return i=this,t&&(this.configuration=t,i.fields.hasWinnings(t.hasWinnings),i.fields.hasCompleteDocuments(t.hasCompleteDocuments),i.fields.hasWinLoss(t.hasWinLoss),i.fields.winLossAmount(t.winLossAmount),i.fields.winLossOperator(t.winLossOperator),i.fields.hasTotalDepositAmount(t.hasTotalDepositAmount),i.fields.totalDepositAmount(t.totalDepositAmount),i.fields.totalDepositAmountOperator(t.totalDepositAmountOperator),i.fields.hasDepositCount(t.hasDepositCount),i.fields.totalDepositCountAmount(t.totalDepositCountAmount),i.fields.totalDepositCountOperator(t.totalDepositCountOperator),i.fields.hasWithdrawalCount(t.hasWithdrawalCount),i.fields.totalWithdrawalCountAmount(t.totalWithdrawalCountAmount),i.fields.totalWithdrawalCountOperator(t.totalWithdrawalCountOperator),i.fields.hasAccountAge(t.hasAccountAge),i.fields.accountAge(t.accountAge),i.fields.accountAgeOperator(t.accountAgeOperator),i.fields.hasFraudRiskLevel(t.hasFraudRiskLevel),i.fields.hasPaymentLevel(t.hasPaymentLevel),i.fields.hasWithdrawalExemption(t.hasWithdrawalExemption)),u=function(){return"Licensee/Licensees?useFilter=true"},r=function(){return"Licensee/GetActiveBrands?licensee="+i.form.fields.licensee.value().id},h.loadLicensees2(u,i.form.fields.licensee,function(){var u,e;return u=h.getBrandLicenseeId(f),e=i.form.fields.licensee.options(),t&&(u=t.licensee,i.form.fields.licensee.isSet(!0)),h.selectLicensee2(i.form.fields.licensee,u),h.loadBrands2(r,i.form.fields.brand,function(){var u;return u=t?t.brand:f.brand().id(),h.selectBrand2(i.form.fields.brand,u),t&&i.form.fields.brand.isSet(!0),i.loadCurrencies(function(){return i.loadVipLevels(function(){return i.loadFraudRisks(function(){var r;return t&&t.brand===u&&(r=[],i.fraudRiskLevelsAssignControl.availableItems().forEach(function(n){return r.push(n)}),r.forEach(function(n){return i.fraudRiskLevelsAssignControl.selectedAvailableItems.push(n),i.fraudRiskLevelsAssignControl.assign()}),r=[],i.fraudRiskLevelsAssignControl.assignedItems().forEach(function(n){return i.configuration.riskLevels.forEach(function(t){if(n.id===t)return r.push(n)})}),r.forEach(function(n){return i.fraudRiskLevelsAssignControl.selectedAssignedItems.push(n),i.fraudRiskLevelsAssignControl.unassign()})),i.loadProducts(function(){return t&&t.hasWinnings?t.winningRules.forEach(function(){return function(n){var t;return t=new c(i.products),t.loadFromRuleDTO(n),i.winningRules.push(t)}}(this)):i.winningRules.push(new c(i.products)),n.resolve()})}),i.loadPaymentLevels(function(){var n,r;if(t&&t.brand===u)return n=[],r=[],i.paymentLevelsAssignControl.availableItems().forEach(function(t){return i.configuration.paymentLevels.indexOf(t.id)!==-1?r.push(t):n.push(t)}),i.paymentLevelsAssignControl.availableItems(n),i.paymentLevelsAssignControl.assignedItems(r)})}),t&&h.selectOption(i.form.fields.currency,function(n){return n===t.currency}),i.form.fields.licensee.value.subscribe(function(){return h.loadBrands2(r,i.form.fields.brand)}),i.form.fields.brand.value.subscribe(function(){var n,t,r,u,f;return $(i.uiElement).parent().hide().prev().show(),n=$.Deferred(),i.loadCurrencies(function(){return n.resolve()}),f=$.Deferred(),i.loadVipLevels(function(){return f.resolve()}),u=$.Deferred(),i.loadProducts(function(){return i.winningRules.removeAll(),i.winningRules.push(new c(i.products)),u.resolve()}),t=$.Deferred(),i.loadFraudRisks(function(){return t.resolve()}),r=$.Deferred(),i.loadPaymentLevels(function(){return r.resolve()}),$.when(r,t,u,f,n).done(function(){return $(i.uiElement).parent().show().prev().hide()})}),i.form.fields.currency.value.subscribe(function(){var n;return n=$.Deferred(),i.loadPaymentLevels(function(){return n.resolve()})})})})})},i.prototype.loadVipLevels=function(n,t){var r,i;return i=$.Deferred(),r=this.getBrandId(),r?$.ajax("RiskProfileCheck/getviplevels?brandId="+r).done(function(r){return function(u){var e,f;return r.form.fields.vipLevels.setOptions(u.vipLevels),e=function(n){var i,t,f,r;for(r=u.vipLevels,t=0,f=r.length;t<f;t++)if(i=r[t],i.id===n)return i},r.configuration&&r.configuration.vipLevels&&(f=_.filter(u.vipLevels,function(n){return _.any(r.configuration.vipLevels,function(t){return n.id===t})}),f.length!==0&&r.form.fields.vipLevels.value(f)),i.resolve(),h.callCallback(n,t)}}(this)):(i.resolve(),h.callCallback(n,t)),i.promise()},i.prototype.loadFraudRisks=function(n,t){var r,i;return i=this,r=i.getBrandId(),r?$.ajax("autoverification/getfraudrisklevels?brandId="+r).done(function(r){return i.fraudRiskLevelsAssignControl.assignedItems([]),i.fraudRiskLevelsAssignControl.availableItems(r.riskLevels),h.callCallback(n,t)}):h.callCallback(n,t)},i.prototype.loadPaymentLevels=function(n,t){var r,u,i;return i=this,r=i.getBrandId(),u=typeof i.fields.currency()!="undefined"?i.fields.currency():i.form.fields.currency.options()[0],r&&u?$.ajax("autoverification/getpaymentlevels?brandId="+r+"&currencyCode="+u).done(function(r){return i.paymentLevelsAssignControl.assignedItems([]),i.paymentLevelsAssignControl.availableItems(r.paymentLevels),h.callCallback(n,t)}):h.callCallback(n,t)},i.prototype.removeWinningRule=function(n){return this.winningRules.remove(n)},i.prototype.addWinningRule=function(){return this.winningRules.push(new c(this.products))},i.prototype.getOperator=function(n){return n===0?">":n===1?"<":n===2?">=":n===3?"<=":void 0},i.prototype.loadCurrencies=function(n,t){var i,r;return r=this,i=r.getBrandId(),i?$.ajax("autoverification/getcurrencies?brandId="+i).done(function(i){return r.form.fields.currency.setOptions(i.currencies),h.callCallback(n,t)}):h.callCallback(n,t)},i.prototype.loadProducts=function(n,t){var i,r;return r=this,i=r.getBrandId(),i?$.ajax("autoverification/GetAllowedBrandProducts?brandId="+i).done(function(i){return r.products=i,h.callCallback(n,t)}):h.callCallback(n,t)},o={gridBodyId:"verification-manager-list",editUrl:"autoverification/verification"},h.addCommonEditFunctions(i.prototype,o),i.prototype.serializeForm=function(){var n;return n=this.form.getDataObject(),this.fields.hasWinnings()&&(n.winningRules=_.map(this.winningRules(),function(n){return{startDate:n.startDate(),endDate:n.endDate(),productId:n.selectedProduct(),amount:n.amount(),comparison:n.comparisonOperator(),period:n.selectedPeriod()}})),JSON.stringify(n)},s=i.prototype.save,i.prototype.save=function(){var n,t,i,u;return n=!1,this.dummyObservable(new Date),this.fields.hasWinnings()&&(this.winningRules().forEach(function(){return function(n){return n.validate()}}(this)),n=_.some(this.winningRules(),function(n){return n.errorMessage()}),n||(i=this.winningRules().length,t=_.map(this.winningRules(),function(n){return n.selectedProduct()}),u=_.uniq(t),i!==u.length&&(n=!0,this.message(r.t("app:fraud.autoVerification.messages.oneRulePerProductAllowed")),this.messageClass("alert alert-danger")))),n?void 0:s.call(this)},e=i.prototype.handleSaveSuccess,i.prototype.handleSaveSuccess=function(n){return n.data=n.data.requestMadeForCreation?r.t("app:fraud.autoVerification.messages.successfullyCreated"):r.t("app:fraud.autoVerification.messages.successfullyUpdated"),e.call(this,n),t.title("View Auto Verification Configuration")},u=i.prototype.handleSaveFailure,i.prototype.handleSaveFailure=function(n){return n.data=r.t("app:fraud.autoVerification.messages."+n.data),u.call(this,n),t.title("Auto Verification Configuration Failure")},i}()})}).call(this);